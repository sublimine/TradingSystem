# INSTITUTIONAL STRATEGY CONFIGURATION
# Based on academic research and institutional standards
# DO NOT modify without understanding implications

# CORRECTED PARAMETERS - 2025-11-11
# Research basis documented in ANALISIS_INSTITUCIONAL_COMPLETO.md

# ============================================================================
# MEAN REVERSION STATISTICAL
# ============================================================================
mean_reversion_statistical:
  enabled: true

  # Entry thresholds - ELITE INSTITUTIONAL (Avellaneda & Lee 2010)
  lookback_period: 200
  lookback_adaptive: true                 # NEW: Adaptive based on volatility
  entry_sigma_threshold: 3.3              # ELITE: Was 2.8 (genuine extremes only)
  exit_sigma_threshold: 0.8

  # Volume confirmation - ELITE (Wyckoff Method)
  volume_spike_multiplier: 3.8            # ELITE: Was 3.2 (climax volume)

  # Reversal velocity - ELITE (Aldridge 2013: institutional snap-backs)
  reversal_velocity_min: 25.0             # ELITE: Was 18.0 (explosive reversals)

  # Microstructure - ELITE thresholds
  vpin_exhaustion_threshold: 0.62         # ELITE: Was 0.40 (true exhaustion)
  imbalance_reversal_threshold: 0.47      # ELITE: Was 0.30 (institutional absorption)
  min_liquidity_score: 0.60

  # Trend filter
  adx_max_for_entry: 27                   # ELITE: Was 22 (75th percentile)
  adx_extreme_reject: 30

  # Equilibrium calculation
  use_vwap_mean: true

  # Confirmation requirements - ELITE CONFLUENCE
  confirmations_required_pct: 0.80        # ELITE: 80% confluence (4/5 factors)

  # Multi-timeframe
  require_h4_alignment: true
  require_d1_no_breakout: true
  min_mtf_confluence: 0.65

# ============================================================================
# LIQUIDITY SWEEP (ICT 2024 Standards)
# ============================================================================
liquidity_sweep:
  enabled: true

  # Penetration parameters - ELITE INSTITUTIONAL
  penetration_min: 6                      # ELITE: Was 3 (too small, broker noise)
  penetration_max: 22                     # ELITE: Was 8 (catches institutional sweeps)
  proximity_threshold: 5                  # ELITE: Was 10 (precision monitoring)

  # Volume confirmation - ELITE
  volume_threshold_multiplier: 3.5        # ELITE: Was 2.8 (stop hunt signature)

  # Reversal velocity - ELITE (explosive institutional absorption)
  reversal_velocity_min: 25.0             # ELITE: Was 12.0 (22-30 pips/min range)

  # Swing detection
  lookback_periods: [60, 120, 240, 480]
  swing_lookback_bars: 50

  # Microstructure - ELITE
  imbalance_threshold: 0.45               # ELITE: Was 0.30 (strong absorption)
  vpin_threshold: 0.30                    # ELITE: LOGIC FIXED - clean flow during setup

  # Confirmation - ELITE CONFLUENCE
  min_confirmation_score: 4               # ELITE: Was 3 (80% not 60%)

  # Multi-timeframe
  require_h4_swing: true
  require_d1_reference: true
  require_h4_trend_alignment: true
  min_mtf_confluence: 0.60

# ============================================================================
# ORDER FLOW TOXICITY - FILTER ONLY
# ============================================================================
# CRITICAL: This is a FILTER, not a signal generator
# Easley, LÃ³pez de Prado & O'Hara (2012): "VPIN >0.7 = toxic flow"
order_flow_toxicity:
  enabled: true
  use_as_filter_only: true                # Does NOT generate signals

  # VPIN thresholds (INVERTED logic - corrected)
  vpin_safe_max: 0.30                     # <0.30 = safe to trade
  vpin_caution_max: 0.45                  # 0.30-0.45 = reduce size
  vpin_toxic_min: 0.55                    # >0.55 = DO NOT TRADE
  vpin_extreme_toxic: 0.70                # >0.70 = NEVER TRADE

  # Historical tracking
  min_consecutive_buckets: 5              # vs 2 retail
  bucket_size: 50000

  # Context verification
  context_verification_enabled: true
  context_verification_bars: 20           # vs 5 retail

# ============================================================================
# MOMENTUM QUALITY
# ============================================================================
momentum_quality:
  enabled: true

  # Momentum detection - ELITE INSTITUTIONAL
  momentum_period: 21                     # ELITE: Was 14 (retail standard, now institutional)
  price_threshold: 0.70                   # ELITE: Was 0.30 (genuine momentum not noise)
  volume_threshold: 2.00                  # ELITE: Was 1.40 (institutional volume)

  # VPIN logic
  vpin_clean_max: 0.30
  vpin_caution_max: 0.50
  vpin_toxic_min: 0.68                    # ELITE: Was 0.55 (true toxicity)

  # Quality scoring - ELITE (matches "Quality" brand)
  min_quality_score: 0.80                 # ELITE: Was 0.65 (premium quality)

  # Context analysis
  lookback_window: 20
  use_regime_filter: true

  # Multi-timeframe
  require_h4_momentum_alignment: true
  require_d1_no_reversal: true
  min_mtf_confluence: 0.60

# ============================================================================
# ORDER BLOCK INSTITUTIONAL
# ============================================================================
order_block_institutional:
  enabled: true

  # Displacement detection - ELITE INSTITUTIONAL
  volume_sigma_threshold: 3.4             # ELITE: Was 2.8 (institutional blocks only)
  displacement_atr_multiplier: 3.0        # ELITE: Was 2.2 (genuine displacement)

  # Block management
  no_retest_enforcement: true
  buffer_atr: 0.5
  max_active_blocks: 5
  block_expiry_hours: 24                  # TODO: Change to volume-weighted expiry

  # Risk management - ELITE
  stop_loss_buffer_atr: 1.15              # ELITE: Was 0.75 (premium protection)
  take_profit_r_multiple: [2.8, 5.2]      # ELITE: Was [2.0, 4.0] (structure-based)

  # Confirmation
  require_ofi_confirmation: true
  require_footprint_confirmation: true

  # Multi-timeframe
  require_h4_order_block: true
  prefer_d1_blocks: true
  min_mtf_confluence: 0.65

# ============================================================================
# KALMAN PAIRS TRADING
# ============================================================================
kalman_pairs_trading:
  enabled: true

  # Monitored pairs - ELITE INSTITUTIONAL (ACTIVATED - was empty!)
  monitored_pairs:
    - ['EURUSD', 'GBPUSD']                # Correlation 0.87
    - ['AUDUSD', 'NZDUSD']                # Correlation 0.92
    - ['EURJPY', 'GBPJPY']                # Correlation 0.89
    - ['XAUUSD', 'XAGUSD']                # Gold-Silver 0.85
    - ['USDCAD', 'WTIUSD']                # Oil-CAD inverse -0.78

  # Entry/exit thresholds - ELITE INSTITUTIONAL
  z_score_entry_threshold: 2.4            # ELITE: Was 1.8 (extreme divergences only)
  z_score_exit_threshold: 1.0             # ELITE: Was 0.3 (better profit capture)

  # Correlation requirements - ELITE
  min_correlation: 0.84                   # ELITE: Was 0.75 (strong relationships)
  lookback_period: 250                    # ELITE: Was 120 (robust statistics)

  # Kalman filter parameters (TODO: Calibrate properly)
  kalman_process_variance: 0.001
  kalman_measurement_variance: 0.01

  # Risk management
  hedge_ratio_recalibration_hours: 24
  max_spread_extension_sigma: 3.5

# ============================================================================
# CORRELATION DIVERGENCE
# ============================================================================
correlation_divergence:
  enabled: true

  # Monitored pairs - ELITE INSTITUTIONAL (ACTIVATED - was empty!)
  monitored_pairs:
    - ['EURUSD', 'GBPUSD']                # EUR/GBP correlation
    - ['AUDUSD', 'NZDUSD']                # AUD/NZD correlation
    - ['EURJPY', 'GBPJPY']                # EUR/GBP vs JPY
    - ['XAUUSD', 'XAGUSD']                # Gold-Silver
    - ['USDCAD', 'USDJPY']                # Different patterns

  # Correlation analysis - ELITE INSTITUTIONAL
  correlation_lookback: 150               # ELITE: Was 60 (robust estimate)
  historical_correlation_min: 0.84        # ELITE: Was 0.65 (strong relationships)
  divergence_correlation_threshold: 0.52  # ELITE: Was 0.50 (stronger divergence)

  # Divergence detection - ELITE
  relative_strength_lookback: 20
  min_divergence_magnitude: 1.8           # ELITE: Was 0.8 (meaningful opportunities)

  # Quality requirements
  convergence_confidence_threshold: 0.70

# ============================================================================
# VOLATILITY REGIME ADAPTATION
# ============================================================================
volatility_regime_adaptation:
  enabled: true

  # Regime detection
  lookback_period: 20
  regime_lookback: 40

  # Entry thresholds - ELITE INSTITUTIONAL
  low_vol_entry_threshold: 1.5            # ELITE: Was 0.8 (less aggressive)
  high_vol_entry_threshold: 2.6           # ELITE: Was 1.8 (conservative in vol)

  # Risk adjustment
  low_vol_stop_multiplier: 1.5
  high_vol_stop_multiplier: 2.5
  low_vol_sizing_boost: 1.2
  high_vol_sizing_reduction: 0.7

  # Confidence requirements - ELITE
  min_regime_confidence: 0.80             # ELITE: Was 0.50 (high certainty required)

  # CRITICAL: Signal generation method
  use_rsi_macd: false                     # RETAIL INDICATORS DISABLED
  use_institutional_signals: true         # USE OFI, STRUCTURE, VOLUME

  # HMM configuration
  use_pretrained_hmm: true
  pretrain_on_historical: true
  hmm_states: 2

# ============================================================================
# BREAKOUT VOLUME CONFIRMATION
# ============================================================================
breakout_volume_confirmation:
  enabled: true

  # Thresholds - ELITE INSTITUTIONAL
  delta_z_threshold: 2.5                  # ELITE: Was 1.6 (institutional absorption)
  displacement_atr_min: 2.4               # ELITE: Was 1.3 (genuine breakout)
  volume_sigma_threshold: 2.8             # ELITE: Was 2.2 (institutional volume)

  # Confirmation
  require_h4_breakout_level: true
  min_mtf_confluence: 0.60

# ============================================================================
# FVG INSTITUTIONAL
# ============================================================================
fvg_institutional:
  enabled: true

  # Gap detection - ELITE INSTITUTIONAL
  gap_atr_minimum: 1.05                   # ELITE: Was 0.5 (significant inefficiencies)
  volume_anomaly_percentile: 82           # ELITE: Was 65 (institutional activity)

  # Risk management
  stop_loss_gap_fraction: 0.382
  take_profit_gap_fraction: 0.786

  # Multi-timeframe
  require_h4_fvg: false
  min_mtf_confluence: 0.55

# ============================================================================
# HTF-LTF LIQUIDITY
# ============================================================================
htf_ltf_liquidity:
  enabled: true

  # Timeframe configuration
  htf_timeframes: ['H1', 'H4', 'D1']
  calculate_htf_internally: true

  # Projection parameters - ELITE INSTITUTIONAL
  projection_tolerance_pips: 2
  swing_lookback_bars: 32                 # ELITE: Was 20 (institutional swings)
  rejection_wick_minimum: 0.60
  zone_tolerance_pips: 2
  min_zone_touches: 4                     # ELITE: NEW (validated institutional zones)

  # Triggers
  triggers: ['rejection_candle', 'volume_climax', 'imbalance_flip']
  min_triggers_required: 1

  # Risk management
  stop_loss_buffer_atr: 0.75

  # HTF update
  htf_update_interval_minutes: 60         # TODO: Change to event-driven

# ============================================================================
# ICEBERG DETECTION
# ============================================================================
iceberg_detection:
  enabled: true

  # Mode configuration
  mode: 'degraded'                        # L2 not available
  accept_low_confidence_degraded: true

  # Detection parameters - ELITE INSTITUTIONAL
  volume_advancement_ratio_threshold: 5.2 # ELITE: Was 3.5 (large institutional icebergs)
  stall_duration_bars: 10                 # ELITE: Was 5 (sustained absorption)
  replenishment_detection: true

  # Risk management - ELITE
  stop_loss_behind_level_atr: 1.5         # ELITE: Was 1.0 (wider stop if iceberg fails)
  take_profit_r_multiple: 3.6             # ELITE: Was 2.5 (strong directional moves)

  # Block management
  max_active_blocks: 5
  block_expiry_hours: 24

# ============================================================================
# IDP INDUCEMENT DISTRIBUTION
# ============================================================================
idp_inducement_distribution:
  enabled: true

  # Penetration parameters - ELITE
  penetration_pips_min: 5
  penetration_pips_max: 32                # ELITE: Was 25 (larger institutional sweeps)

  # Volume confirmation - ELITE
  volume_multiplier: 3.5                  # ELITE: Was 2.0 (premium inducement signature)

  # Distribution phase
  distribution_range_bars_min: 3
  distribution_range_bars_max: 8

  # Displacement velocity - ELITE INSTITUTIONAL
  displacement_velocity_pips_per_minute: 18  # ELITE: Was 7 (explosive institutional move)

  # Risk management - ELITE
  stop_loss_beyond_inducement: true
  take_profit_r_multiple: 4.0             # ELITE: Was 3.0 (full IDP extension)

  # Multi-timeframe
  require_h4_idp_context: true

# ============================================================================
# OFI REFINEMENT
# ============================================================================
ofi_refinement:
  enabled: true

  # OFI calculation - ELITE INSTITUTIONAL
  window_ticks: 100
  window_adaptive: true                   # NEW: Adaptive based on volatility
  z_entry_threshold: 2.5                  # ELITE: Was 1.5 (extreme imbalances only)
  lookback_periods: 500
  lookback_adaptive: true                 # NEW: Adaptive based on regime

  # VPIN filter
  vpin_max_safe: 0.35
  price_coherence_required: true

  # Data requirements
  min_data_points: 200

  # Risk management
  stop_loss_atr_multiplier: 2.5
  take_profit_atr_multiplier: 4.0

  # Multi-timeframe
  min_mtf_confluence: 0.55

# ============================================================================
# GLOBAL SETTINGS
# ============================================================================
global:
  # Multi-timeframe
  default_mtf_timeframes: ['M5', 'M15', 'M30', 'H1', 'H4', 'D1']
  min_mtf_confluence_default: 0.60

  # VPIN global filter
  use_vpin_global_filter: true
  vpin_global_max: 0.55                   # Block ALL trades if VPIN > 0.55

  # Regime adaptation
  require_regime_compatibility: true

  # Session filters
  trading_sessions:
    london: {start: '08:00', end: '16:00'}
    new_york: {start: '13:00', end: '22:00'}
    tokyo: {start: '00:00', end: '09:00'}

  preferred_sessions: ['london', 'new_york']

  # Risk management
  max_correlation_exposure: 5.0           # Max % capital in correlated positions
  daily_loss_limit: 5.0                   # Pause trading if daily loss > 5%
  max_drawdown_pause: 20.0                # Pause if drawdown > 20%
